//calc.h

#define NUMBER '0'

void push(double);
double pop(void);
int getop(char[]);
int getch(void);
void ungetch(int);

//getch.cpp

#include <stdio.h>
#define BUFSIZE 100

char buf[BUFSIZE]; /* буфер для ungetch */
int bufp = 0; /* след, свободная позиция в буфере */

int getch(void) /* взять (возможно возвращенный) символ */
{
	return (bufp > 0) ? buf[--bufp] : getchar();
}

void ungetch(int c) /* вернуть символ на ввод */
{
	if (bufp >= BUFSIZE)
		printf("ungetch: слишком много символов\n");
	else
		buf[bufp++] = c;
}


//stack.cpp

#include <stdio.h>
#include "calc.h"
#define MAXVAL 100 /* максимальная глубина стека */

int sp = 0; /* следующая свободная позиция в стеке */
double val[MAXVAL]; /* стек */

/* push: положить значение f в стек */
void push(double f) {
	if (sp < MAXVAL)
		val[sp++] = f;
	else
		printf("ошибка: стек полон, %g не помещается", f);
}

/* pop: взять с вершины стека и выдать в качестве результата */
double pop(void) {
	if (sp > 0)
		return val[--sp];
	else {
		printf("ошибка: стек пуст");
		return 0.0;
	}
}


//getop.cpp

#include <ctype.h>
#include <stdio.h>
#include <string.h>
#include "calc.h"

int getch(void);
void ungetch(int);

int getop(char s[]) {
	int i, c;

	while ((s[0] = c = getch()) == ' ' || c == '\t');
	s[1] = '\0';

	if (!isdigit(c) && c != '.' && c != '-') {
		i = 0;
		if (isalpha(c)) {
			while (isalpha(s[++i] = c = getch()));
			s[i] = '\0';
			ungetch(c);

			if (strcmp(s, "sin") == 0) return 's';
			if (strcmp(s, "e") == 0) return 'e';
			if (strcmp(s, "^") == 0) return '^';
			if (strcmp(s, "q") == 0) return 'q';
		}
		return c; /* не число */
	}

	i = 0;
	if (c == '-') {
		if (isdigit(c = getch()) || c == '.') {
			s[++i] = c;
		}
		else {
			ungetch(c);
			return '-';
		}
	}

	if (isdigit(c)) /* накапливаем целую часть */
		while (isdigit(s[++i] = c = getch()));
	if (c == '.') /* накапливаем дробную часть */
		while (isdigit(s[++i] = c = getch()));
	s[i] = '\0';

	if (c != EOF)
		ungetch(c);
	return NUMBER;
}


//main.cpp

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>
#include "calc.h"

#define MAXOP 100

int main() {
    int type;
    double op1, op2;
    char s[MAXOP];

    printf("Калькулятор (поддерживает +, -, *, /, ^, e, sin)\n");
    printf("Введите выражение в обратной польской записи (для выхода введите q)\n");

    while ((type = getop(s)) != EOF) {
        switch (type) {
        case NUMBER:
            push(atof(s));
            break;
        case '+':
            push(pop() + pop());
            break;
        case '*':
            push(pop() * pop());
            break;
        case '-':
            op2 = pop();
            push(pop() - op2);
            break;
        case '/':
            op2 = pop();
            if (op2 != 0.0)
                push(pop() / op2);
            else
                printf("ошибка: деление на нуль\n");
            break;
        case 's':
            push(sin(pop()));
            break;
        case 'e':
            push(exp(pop()));
            break;
        case '^':
            op2 = pop();
            op1 = pop();
            if (op1 == 0.0 && op2 <= 0.0)
                printf("ошибка: основание 0 при степени <= 0\n");
            else
                push(pow(op1, op2));
            break;
        case 'q':
            return 0;
        case '\n':
            printf("%.8g\n", pop());
            break;
        default:
            printf("ошибка: неизвестная операция %s\n", s);
            break;
        }
    }
    return 0;
}
